<?xml version="1.0" encoding="UTF-8"?>
<?eclipse version="3.3"?>

<!-- 
/*******************************************************************************
 * Copyright (c) 2005-2008 VecTrace (Zingo Andersen) and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     VecTrace (Zingo Andersen) - implementation
 *     Software Balm Consulting Inc (Peter Hunnisett <peter_hge at softwarebalm dot com>) - some updates
 *     StefanC                   - Some updates
 *     Charles O'Farrell         - Annotation with color
 *     Jerome Negre              - Moving menus around
 *     Sebastian                 - Better naming
 *******************************************************************************/
-->

<plugin>

<!--            Team exstension points                     -->
   <extension point="org.eclipse.team.core.repository">
	  <repository
    	 class="com.vectrace.MercurialEclipse.team.MercurialTeamProvider"
		 id="com.vectrace.MercurialEclipse.team.MercurialTeamProvider"
		  metaFilePaths=".hg/">
 	  </repository>
   </extension>
	<extension point="org.eclipse.team.ui.configurationWizards">
	   <wizard
	        name="Mercurial"
	        icon="icons/mercurialeclipse.png"
	        class="com.vectrace.MercurialEclipse.team.MercurialConfigurationWizard"
	        id="com.vectrace.MercurialEclipse.team.MercurialConfigurationWizard">
	   </wizard>
	</extension>

<!-- TODO 
	<extension point="org.eclipse.team.ui.synchronizeParticipants">
	   <participant
	        icon="icons/mercurialeclipse.png"
	        id="com.vectrace.MercurialEclipse.team.MercurialSynchronizeParticipant"
	        class="com.vectrace.MercurialEclipse.team.MercurialSynchronizeParticipant"
	        name="Mercurial Syncronisation"
	        persistent="true">
	   </participant>
	</extension>

	<extension point= "org.eclipse.team.ui.synchronizeWizards" >
	   <wizard
	        name="Mercurial"
			description="Mercurial synchronize wizard"
	        icon="icons/mercurialeclipse.png"
	        class="com.vectrace.MercurialEclipse.team.MercurialConfigurationWizard"
	        id="com.vectrace.MercurialEclipse.team.MercurialConfigurationWizard">
	   </wizard>
	</extension>
-->

	<extension point="org.eclipse.ui.decorators">
	    <decorator
	            adaptable="true"
	            label="Mercurial Eclipse decorations"
	            state="false"
	            lightweight= "true"
	            location= "BOTTOM_RIGHT"
	            class="com.vectrace.MercurialEclipse.team.ResourceDecorator"
	            id="com.vectrace.MercurialEclipse.team.ResourceDecorator">
	         <description>
	            Label decorations for Mercurial eclipse plugin.
	         </description>
	         <enablement>
               <objectClass name="org.eclipse.core.resources.IResource"/>

               <!-- pluginState
                 id="com.vectrace.MercurialEclipse.team.MercurialTeamProvider"
                 value="activated" >
               </pluginState -->
                 
               
	         </enablement>
	    </decorator>
	</extension>

	<!-- propertyTesters -->
	<extension point="org.eclipse.core.expressions.propertyTesters">
		<!-- tests for added,clean,deleted,ignore,modified,removed,unknown -->
	  	<propertyTester
	         class="com.vectrace.MercurialEclipse.menu.FlagPropertyTester"
	         id="com.vectrace.MercurialEclipse.propertyTester"
	         namespace="com.vectrace.MercurialEclipse.propertyTester"
	         properties="status"
	         type="com.vectrace.MercurialEclipse.model.FlaggedResource">
	  	</propertyTester>
	</extension>
	
	<!-- expressions.definitions -->
	<extension point="org.eclipse.core.expressions.definitions">
		<!-- mercurial -->
		<definition id="com.vectrace.MercurialEclipse.def.mercurial">
			<iterate>
				<adapt type="org.eclipse.core.resources.IResource">
					<test
					      property="org.eclipse.core.resources.projectPersistentProperty"
					      args="org.eclipse.team.core.repository,com.vectrace.MercurialEclipse.team.MercurialTeamProvider">
					</test>
				</adapt>
			</iterate>
		</definition>
		<!-- notInMercurial -->
		<definition id="com.vectrace.MercurialEclipse.def.notInMercurial">
	        <iterate>
	           <adapt type="com.vectrace.MercurialEclipse.model.FlaggedResource">
	           	<test 
	                  property="com.vectrace.MercurialEclipse.propertyTester.status"
	                  args="unknown,ignore">
	           	</test>
	           </adapt>
	        </iterate>
		</definition>
		<!-- hgUnknown -->
		<definition id="com.vectrace.MercurialEclipse.def.hgUnknown">
			<iterate>
				<adapt type="com.vectrace.MercurialEclipse.model.FlaggedResource">
		           	<test property="com.vectrace.MercurialEclipse.propertyTester.status"
	    	              args="unknown"/>
					<not>
						<test property="com.vectrace.MercurialEclipse.propertyTester.status"
						      args="added,clean,modified"/>
					</not>
	           </adapt>
           </iterate>
		</definition>
		<!-- merging -->
		<definition id="com.vectrace.MercurialEclipse.def.merging">
			<iterate>
				<adapt type="org.eclipse.core.resources.IResource">
					<test
					      property="org.eclipse.core.resources.projectPersistentProperty"
					      args="com.vectrace.MercurialEclipse.merging">
					</test>
				</adapt>
			</iterate>
		</definition>
		<!-- notMerging -->
		<definition id="com.vectrace.MercurialEclipse.def.notMerging">
			<iterate>
				<adapt type="org.eclipse.core.resources.IResource">
					<not>
						<test
						      property="org.eclipse.core.resources.projectPersistentProperty"
						      args="com.vectrace.MercurialEclipse.merging">
						</test>
					</not>
				</adapt>
			</iterate>
		</definition>
	</extension>

	<!-- commands -->
	<extension point="org.eclipse.ui.commands">
		<command id="com.vectrace.MercurialEclipse.menu.CommitMergeHandler"
		         name="Commit merge"/>
		<command id="com.vectrace.MercurialEclipse.menu.CommitHandler"
		         name="Commit..."/>
		<command id="com.vectrace.MercurialEclipse.menu.UpdateHandler"
		         name="Update"/>

		<command id="com.vectrace.MercurialEclipse.menu.MergeHandler"
		         name="Merge..."/>
		<command id="com.vectrace.MercurialEclipse.menu.SwitchHandler"
		         name="Swith to Another Changeset..."/>

		<command id="com.vectrace.MercurialEclipse.menu.AddHandler"
		         name="Add to Version Control..."/>
		<command id="com.vectrace.MercurialEclipse.menu.HgIgnoreHandler"
		         name="Add to .hgignore..."/>
	</extension>

	<!-- handlers -->
	<extension point="org.eclipse.ui.handlers">

		<!-- CommitMergeHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.CommitMergeHandler"
		         class="com.vectrace.MercurialEclipse.menu.CommitMergeHandler">
			<enabledWhen>
				<count value="1"/>
			</enabledWhen>
		</handler>

		<!-- CommitHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.CommitHandler"
		         class="com.vectrace.MercurialEclipse.menu.CommitHandler"/>

		<!-- UpdateHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.UpdateHandler"
		         class="com.vectrace.MercurialEclipse.menu.UpdateHandler">
			<enabledWhen>
				<count value="1"/>
			</enabledWhen>
		</handler>

		<!-- MergeHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.MergeHandler"
		         class="com.vectrace.MercurialEclipse.menu.MergeHandler">
			<enabledWhen>
				<and>
					<count value="1"/>
					<reference definitionId="com.vectrace.MercurialEclipse.def.notMerging"/>
				</and>
			</enabledWhen>
		</handler>

		<!-- SwitchHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.SwitchHandler"
		         class="com.vectrace.MercurialEclipse.menu.SwitchHandler">
			<enabledWhen>
				<count value="1"/>
			</enabledWhen>
		</handler>

		<!-- AddHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.AddHandler"
		         class="com.vectrace.MercurialEclipse.menu.AddHandler">
			<enabledWhen>
				<reference definitionId="com.vectrace.MercurialEclipse.def.notInMercurial"/>
			</enabledWhen>
		</handler>

		<!-- HgIgnoreHandler -->
		<handler commandId="com.vectrace.MercurialEclipse.menu.HgIgnoreHandler"
		         class="com.vectrace.MercurialEclipse.menu.HgIgnoreHandler">
			<enabledWhen>
				<and>
					<count value="1"/>
					<reference definitionId="com.vectrace.MercurialEclipse.def.hgUnknown"/>
				</and>
			</enabledWhen>
		</handler>
	</extension>

	<extension point="org.eclipse.ui.menus">
		<menuContribution locationURI="popup:org.eclipse.ui.popup.any?after=additions">
			<menu label="Team" id="team.main">
				<separator name="group1" visible="true"/>
				<command commandId="com.vectrace.MercurialEclipse.menu.CommitMergeHandler">
					<visibleWhen>
						<and>
							<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
							<reference definitionId="com.vectrace.MercurialEclipse.def.merging"/>
						</and>
					</visibleWhen>
				</command>
				<command commandId="com.vectrace.MercurialEclipse.menu.CommitHandler">
					<visibleWhen>
						<and>
							<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
							<reference definitionId="com.vectrace.MercurialEclipse.def.notMerging"/>
						</and>
					</visibleWhen>
				</command>
				<command commandId="com.vectrace.MercurialEclipse.menu.UpdateHandler">
					<visibleWhen>
						<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
					</visibleWhen>
				</command>
				<separator name="group2" visible="false"/><!-- TODO visible="true" -->
				<separator name="group3" visible="true"/>
				<command commandId="com.vectrace.MercurialEclipse.menu.MergeHandler" icon="icons/branches_rep.gif">
					<visibleWhen>
						<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
					</visibleWhen>
				</command>
				<command commandId="com.vectrace.MercurialEclipse.menu.SwitchHandler">
					<visibleWhen>
						<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
					</visibleWhen>
				</command>
				<separator name="group4" visible="true"/>
				<separator name="group5" visible="true"/>
				<separator name="group6" visible="true"/>
				<separator name="group7" visible="true"/>
				<separator name="group8" visible="true"/>
				<separator name="group9" visible="true"/>
				<separator name="group10" visible="true"/>
				<command commandId="com.vectrace.MercurialEclipse.menu.AddHandler">
					<visibleWhen>
						<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
					</visibleWhen>
				</command>
				<!--
				<command commandId="com.vectrace.MercurialEclipse.handlers.RemoveHandler"/>
				-->
				<command commandId="com.vectrace.MercurialEclipse.menu.HgIgnoreHandler">
					<visibleWhen>
						<reference definitionId="com.vectrace.MercurialEclipse.def.mercurial"/>
					</visibleWhen>
				</command>
			</menu>
		</menuContribution>
	</extension>

   <extension
         point="org.eclipse.ui.popupMenus">

<!--            All Team menu                     -->
              
       <objectContribution
           adaptable="true"
           objectClass="org.eclipse.core.resources.IResource"
           id="com.vectrace.MercurialEclipse.IResourceContributions">
           <filter
               name="projectPersistentProperty"
               value="org.eclipse.team.core.repository=com.vectrace.MercurialEclipse.team.MercurialTeamProvider">
           </filter>
           
           <!-- Team -->
           <action
               label="Remove from Version Control"
               class="com.vectrace.MercurialEclipse.team.ActionRemove"
               tooltip="hg remove"
               menubarPath="team.main/group10"
               id="com.vectrace.MercurialEclipse.team.ActionRemove">
           </action>
           <action
               label="Tag as Version..."
               class="com.vectrace.MercurialEclipse.team.TagAction"
               icon="icons/tags.gif"
               menubarPath="team.main/group3"
               id="com.vectrace.MercurialEclipse.team.TagAction"
               enablesFor="1">
           </action>
           <action
               label="Show &amp;History"
               class="com.vectrace.MercurialEclipse.team.ActionChangeLog"
               icon="icons/history.gif"
               tooltip="hg log"
               menubarPath="team.main/group4"
               id="com.vectrace.MercurialEclipse.team.ActionChangeLog">
           </action>
           <action
               label="&amp;Revert"
               class="com.vectrace.MercurialEclipse.team.ActionRevert"
               tooltip="hg revert"
               menubarPath="team.main/group2"
               id="com.vectrace.MercurialEclipse.team.ActionRevert">
           </action>
           <action
               label="&amp;Import patch"
               class="com.vectrace.MercurialEclipse.team.ActionImport"
               tooltip="Import patch from file (hg import)"
               menubarPath="team.main/group2"
               id="com.vectrace.MercurialEclipse.team.ActionImport">
           </action>
           <action
               label="Pull..."
               class="com.vectrace.MercurialEclipse.team.ActionPull"
               tooltip="pull changes from remote/local reposetory (hg pull)"
               menubarPath="team.main/group2"
               id="com.vectrace.MercurialEclipse.team.ActionPull">
           </action>
           <action
               label="Push..."
               class="com.vectrace.MercurialEclipse.team.ActionPush"
               tooltip="push changes to remote/local reposetory (hg push)"
               menubarPath="team.main/group2"
               id="com.vectrace.MercurialEclipse.team.ActionPush">
           </action>
      </objectContribution>
      
      <!-- File Team Menu -->
      <objectContribution
            adaptable="true"
            objectClass="org.eclipse.core.resources.IFile"
            id="com.vectrace.MercurialEclipse.IFileContributions">
           <filter
               name="projectPersistentProperty"
               value="org.eclipse.team.core.repository=com.vectrace.MercurialEclipse.team.MercurialTeamProvider">
           </filter>
                 <!-- Team -->
            <action
               label="Show Annotation"
               icon="icons/annotate.gif"
               class="com.vectrace.MercurialEclipse.team.ShowAnnotationAction"
               tooltip="hg annotate"
               menubarPath="team.main/group3"
               id="com.vectrace.MercurialEclipse.team.ShowAnnotationAction"
               enablesFor="1">
           </action>
                 <!-- Compare -->
           <action
               label="Another Changeset..."
               class="com.vectrace.MercurialEclipse.team.CompareWithAction"
               tooltip="hg diff"
               menubarPath="compareWithMenu/compareWithGroup"
               id="com.vectrace.MercurialEclipse.team.CompareWithAction"
               enablesFor="1">
           </action>
           <action
               label="Parent Changeset"
               class="com.vectrace.MercurialEclipse.team.CompareAction"
               tooltip="hg diff"
               menubarPath="compareWithMenu/compareWithGroup"
               id="com.vectrace.MercurialEclipse.team.CompareAction"
               enablesFor="1">
           </action>
      </objectContribution>
   </extension>

   <extension point="org.eclipse.ui.preferencePages">
      <page class="com.vectrace.MercurialEclipse.preferences.MercurialPreferencePage"
            id="com.vectrace.MercurialEclipse.prefspage"
            category="org.eclipse.team.ui.TeamPreferences"
            name="Mercurial Eclipse"/>
   </extension>

   <extension point="org.eclipse.core.runtime.preferences">
      <initializer class="com.vectrace.MercurialEclipse.preferences.PreferenceInitializer"/>
   </extension>
   
   <extension point="org.eclipse.ui.importWizards">
      <category
            id="com.vectrace.MercurialEclipse.wizards.sampleCategory"
            name="Mercurial"/>
      <wizard
            category="com.vectrace.MercurialEclipse.wizards.sampleCategory"
            class="com.vectrace.MercurialEclipse.wizards.CloneRepoWizard"
            icon="icons/mercury_Hg.png"
            id="com.vectrace.MercurialEclipse.wizards.ImportWizard"
            name="Clone Repository using Mercurial">
         <description>
            Import a file from the local file system into the workspace.
         </description>
      </wizard>
   </extension>
   
   <extension point="org.eclipse.ui.newWizards">
      <category
            id="com.vectrace.MercurialEclipse"
            name="Mercurial"/>
      <wizard
            canFinishEarly="false"
            category="com.vectrace.MercurialEclipse"
            class="com.vectrace.MercurialEclipse.wizards.CloneRepoWizard"
            icon="icons/mercury_Hg.png"
            id="com.vectrace.MercurialEclipse.wizards.NewHgProjectWizard"
            name="Clone Repository using Mercurial"
            project="true"/>
   </extension>

   <extension
         point="org.eclipse.ui.workbench.texteditor.quickDiffReferenceProvider">
      <referenceprovider
            label="Hg Quick Diff"
            class="com.vectrace.MercurialEclipse.annotations.HgPristineCopyQuickDiffProvider"
            id="com.vectrace.MercurialEclipse.annotations.HgReferenceProvider">
      </referenceprovider>
   </extension>

   <!-- Adapters -->
   <extension point="org.eclipse.core.runtime.adapters">
     <factory
       adaptableType="org.eclipse.team.core.history.provider.FileHistoryProvider"
       class="com.vectrace.MercurialEclipse.AdapterFactory">
       <adapter type="org.eclipse.team.ui.history.IHistoryPageSource"/>
     </factory>
     <factory
       adaptableType="org.eclipse.core.resources.IResource"
       class="com.vectrace.MercurialEclipse.ResourceAdapterFactory">
       <adapter type="com.vectrace.MercurialEclipse.model.FlaggedResource"/>
     </factory>
   </extension>
   
   <!-- Views -->
   
   <extension point="org.eclipse.ui.views">
      <view
        class="com.vectrace.MercurialEclipse.views.MergeView"
        id="com.vectrace.MercurialEclipse.views.MergeView"
        icon="icons/branches_rep.gif"
        name="Merge">
      </view>
   </extension>
   
</plugin>
